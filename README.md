# Call Router Microservice (Тестове завдання)

Цей проєкт моделює мікросервіс **Call Router**, який приймає SIP-сигналізацію, приймає рішення, куди спрямувати виклик, і зберігає базову статистику по дзвінках.

---

## Що потрібно зробити — коротко

### 1. Обробка REGISTER
- Зберігати або оновлювати інформацію про абонента у **Redis**.
- Встановити TTL для запису — **30 хвилин**.

### 2. Маршрутизація INVITE
- Шукати **next hop** (наступний вузол маршруту) у таблиці маршрутів.
- Якщо адресат **не знайдений** — відправляти відповідь **404 Not Found**.
- Якщо знайдений — проксувати SIP INVITE запит на знайдений next hop.

### 3. CDR (Call Detail Record)
- Створювати JSON-запис про кожен дзвінок у **PostgreSQL**.
- Запис створювати при **першому INVITE**.
- Оновлювати запис при отриманні **BYE**.

### 4. Метрики — `/metrics/calls`
- Відповідати кількістю **активних викликів**.
- Відповідати **середньою тривалістю** завершених викликів.

### 5. CI та тести
- Юніт-тести з покриттям **≥ 70 %** коду.
- Автоматичний запуск тестів через **GitHub Actions** або **GitLab CI** з командою `mvn test`.

---

## Використані технології

- **Java 17+**
- **Spring Boot 3**
- **PostgreSQL 15+**
- **Redis**
- **jain-sip** (або аналогічна SIP-бібліотека)
- **Docker Compose** для локального розгортання залежностей (PostgreSQL, Redis)

---

## Детальна постановка задачі

### Обробка REGISTER
- Приймати SIP REGISTER повідомлення.
- Зберігати у Redis дані про абонента (його URI та IP).
- Встановити час життя запису в Redis на 30 хвилин.

### Обробка INVITE
- За URI адресата шукати next hop у таблиці маршрутів (можна зберігати у Redis або БД).
- Якщо next hop не знайдений, відповідати клієнту SIP статусом 404.
- Якщо next hop знайдений — проксувати SIP INVITE туди, одночасно створюючи запис CDR у PostgreSQL.

### Обробка BYE
- Оновлювати запис CDR, встановлюючи час завершення виклику та тривалість.

### Метрики
- Підрахунок кількості активних викликів (статус “in_progress”).
- Обчислення середньої тривалості завершених викликів.
- Експонування цих метрик через REST-ендпоінт `/metrics/calls`.

### CI/CD
- Забезпечити покриття юніт-тестами не менше 70%.
- Налаштувати pipeline для автоматичного запуску `mvn test` у GitHub Actions або GitLab CI.

---

## Локальний запуск (Docker Compose)

```bash
docker-compose up -d
